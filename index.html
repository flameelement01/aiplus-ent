<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –ï–ù–¢ ‚Äî Aiplus</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #080808;
      --card: #111111;
      --card2: #181818;
      --border: #222222;
      --border2: #333333;
      --accent: #d4f53c;
      --teal: #3cf5d4;
      --text: #f0f0f0;
      --dim: #888888;
      --muted: #444444;
    }
    html, body { background: var(--bg); color: var(--text); font-family: 'Manrope', sans-serif; min-height: 100vh; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .header {
      width: 100%; padding: 18px 32px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--border); position: sticky; top: 0;
      background: rgba(8,8,8,0.95); backdrop-filter: blur(12px); z-index: 100;
    }
    .logo { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; }
    .logo span { color: var(--accent); }
    .badge {
      background: rgba(212,245,60,0.12); color: var(--accent);
      border: 1px solid rgba(212,245,60,0.25); border-radius: 20px;
      padding: 4px 14px; font-size: 12px; font-weight: 700; letter-spacing: 0.5px;
    }
    .main { max-width: 680px; margin: 0 auto; padding: 40px 20px 80px; }

    /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
    .progress-wrap { width: 100%; height: 2px; background: var(--border); border-radius: 2px; margin-bottom: 36px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.5s ease; }

    /* ‚îÄ‚îÄ STEP LABEL ‚îÄ‚îÄ */
    .step-label { font-size: 11px; color: var(--muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px; }
    .question-emoji { font-size: 38px; display: block; margin-bottom: 12px; }
    .question-title { font-size: 24px; font-weight: 900; line-height: 1.25; margin-bottom: 24px; letter-spacing: -0.5px; }

    /* ‚îÄ‚îÄ OPTIONS ‚îÄ‚îÄ */
    .options-grid { display: grid; gap: 10px; margin-bottom: 28px; }
    .options-grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .options-grid.cols-1 { grid-template-columns: 1fr; }
    .option-btn {
      display: flex; align-items: center; gap: 10px;
      padding: 13px 16px; background: var(--card);
      border: 1.5px solid var(--border); border-radius: 12px;
      cursor: pointer; font-size: 14px; font-weight: 400;
      color: var(--text); font-family: 'Manrope', sans-serif;
      transition: all 0.15s; text-align: left; width: 100%;
    }
    .option-btn.selected {
      background: rgba(212,245,60,0.1);
      border-color: var(--accent); color: var(--accent); font-weight: 700;
    }
    .option-btn:hover:not(.selected) { border-color: var(--border2); }
    .check-circle {
      width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0;
      border: 2px solid var(--muted); background: transparent;
      display: flex; align-items: center; justify-content: center;
      font-size: 9px; color: #000; transition: all 0.15s;
    }
    .option-btn.selected .check-circle {
      border-color: var(--accent); background: var(--accent);
    }

    /* ‚îÄ‚îÄ VERSUS (MBTI) ‚îÄ‚îÄ */
    .axis-row { display: flex; justify-content: center; margin-bottom: 16px; }
    .axis-pill {
      background: rgba(212,245,60,0.12); border: 1px solid rgba(212,245,60,0.25);
      border-radius: 20px; padding: 4px 14px; font-size: 12px; font-weight: 700; color: var(--accent);
    }
    .versus-grid { display: grid; grid-template-columns: 1fr 36px 1fr; gap: 10px; margin-bottom: 28px; }
    .versus-card {
      background: var(--card); border: 2px solid var(--border);
      border-radius: 16px; padding: 18px 14px; cursor: pointer;
      transition: all 0.2s; display: flex; flex-direction: column; gap: 8px;
    }
    .versus-card.sel-left  { background: #1b2b00; border-color: var(--accent); }
    .versus-card.sel-right { background: #001e1a; border-color: var(--teal); }
    .versus-card:hover:not(.sel-left):not(.sel-right) { border-color: var(--border2); }
    .versus-right { text-align: right; }
    .versus-emoji { font-size: 26px; }
    .versus-label { font-size: 14px; font-weight: 800; line-height: 1.2; }
    .versus-desc  { font-size: 11px; color: var(--dim); line-height: 1.5; flex-grow: 1; }
    .versus-tag   { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); }
    .sel-left  .versus-tag { color: var(--accent); }
    .sel-right .versus-tag { color: var(--teal); }
    .vs-orb { display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: var(--muted); }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-row { display: flex; align-items: center; margin-top: 8px; gap: 10px; }
    .btn-primary {
      background: var(--accent); color: #000; border: none;
      border-radius: 12px; padding: 14px 28px; font-size: 15px;
      font-weight: 900; cursor: pointer; font-family: 'Manrope', sans-serif;
      transition: opacity 0.15s; letter-spacing: -0.3px;
    }
    .btn-primary:disabled { opacity: 0.35; cursor: default; }
    .btn-back {
      background: transparent; color: var(--dim);
      border: 1px solid var(--border); border-radius: 12px;
      padding: 14px 22px; font-size: 14px; cursor: pointer;
      font-family: 'Manrope', sans-serif;
    }

    /* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
    .hero-title { font-size: 40px; font-weight: 900; line-height: 1.15; letter-spacing: -1px; margin-bottom: 14px; }
    .hero-sub { font-size: 15px; color: var(--dim); line-height: 1.65; margin-bottom: 32px; }
    .feat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 32px; }
    .feat-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; }
    .feat-emoji { font-size: 26px; margin-bottom: 8px; }
    .feat-title { font-size: 14px; font-weight: 800; margin-bottom: 4px; }
    .feat-desc  { font-size: 12px; color: var(--dim); line-height: 1.5; }
    .hero-note  { font-size: 12px; color: var(--muted); margin-top: 12px; }

    /* ‚îÄ‚îÄ CONTACT FORM ‚îÄ‚îÄ */
    .form-section { margin-bottom: 28px; }
    .form-label { font-size: 12px; color: var(--dim); margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
    .form-input {
      width: 100%; background: var(--card); border: 1.5px solid var(--border);
      border-radius: 12px; padding: 14px 16px; font-size: 15px;
      color: var(--text); font-family: 'Manrope', sans-serif; outline: none;
      transition: border-color 0.15s;
    }
    .form-input:focus { border-color: var(--accent); }
    .form-input::placeholder { color: var(--muted); }
    .form-note { font-size: 12px; color: var(--muted); margin-top: 20px; line-height: 1.6; }
    .form-note a { color: var(--accent); text-decoration: none; }

    /* ‚îÄ‚îÄ RESULT ‚îÄ‚îÄ */
    .result-header { font-size: 11px; color: var(--accent); font-weight: 700; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px; }
    .result-title  { font-size: 24px; font-weight: 900; letter-spacing: -0.5px; margin-bottom: 20px; }
    .mbti-badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(212,245,60,0.12); border: 1px solid rgba(212,245,60,0.25);
      border-radius: 10px; padding: 8px 16px; font-size: 15px;
      font-weight: 800; color: var(--accent); margin-bottom: 20px;
    }
    .result-box {
      white-space: pre-wrap; font-size: 14px; line-height: 1.8;
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; padding: 24px; margin-bottom: 24px;
    }
    .aiplus-cta {
      padding: 16px 20px; background: rgba(212,245,60,0.06);
      border: 1px solid rgba(212,245,60,0.2); border-radius: 14px;
      font-size: 13px; line-height: 1.65; margin-top: 20px;
    }
    .aiplus-cta strong.accent { color: var(--accent); }
    .aiplus-cta .dimmed { color: var(--dim); }

    /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
    .chat-section-title { font-size: 14px; font-weight: 800; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
    .chat-subtitle { font-size: 12px; color: var(--dim); margin-bottom: 10px; }
    .chat-wrap { display: flex; flex-direction: column; height: 360px; background: var(--card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
    .chat-head { padding: 14px 20px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 700; color: var(--dim); display: flex; align-items: center; gap: 8px; }
    .chat-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
    .chat-msgs { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 10px; }
    .bubble {
      max-width: 82%; padding: 11px 14px; font-size: 13px;
      line-height: 1.6; white-space: pre-wrap;
    }
    .bubble.user {
      border-radius: 14px 14px 4px 14px;
      background: var(--accent); color: #000; font-weight: 700;
      align-self: flex-end;
    }
    .bubble.bot {
      border-radius: 14px 14px 14px 4px;
      background: var(--card2); color: var(--text); font-weight: 400;
      border: 1px solid var(--border); align-self: flex-start;
    }
    .chat-input-row { padding: 10px 14px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
    .chat-input {
      flex: 1; background: var(--bg); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 14px; color: var(--text);
      font-size: 13px; outline: none; font-family: 'Manrope', sans-serif;
      transition: border-color 0.15s;
    }
    .chat-input:focus { border-color: var(--border2); }
    .chat-input::placeholder { color: var(--muted); }
    .send-btn {
      background: var(--accent); border: none; border-radius: 10px;
      padding: 10px 16px; color: #000; font-weight: 900; cursor: pointer;
      font-size: 14px; font-family: 'Manrope', sans-serif;
    }
    .send-btn:disabled { opacity: 0.5; cursor: default; }

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    .loading-screen { text-align: center; padding: 60px 0; }
    .loading-emoji { font-size: 40px; margin-bottom: 16px; }
    .loading-title { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
    .loading-sub   { font-size: 14px; color: var(--dim); }
    .dots-wrap { display: flex; gap: 5px; padding: 10px; justify-content: center; margin-top: 24px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); }
    .dot:nth-child(1) { animation: bounce 1.2s 0.0s infinite ease-in-out; }
    .dot:nth-child(2) { animation: bounce 1.2s 0.2s infinite ease-in-out; }
    .dot:nth-child(3) { animation: bounce 1.2s 0.4s infinite ease-in-out; }
    .chat-dots { display: flex; gap: 5px; padding: 10px 14px; align-self: flex-start; }
    .chat-dots .dot { animation-duration: 1.2s; }

    /* ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ */
    .success-screen { text-align: center; padding: 40px 20px; }
    .success-icon { font-size: 56px; margin-bottom: 20px; }
    .success-title { font-size: 26px; font-weight: 900; margin-bottom: 12px; letter-spacing: -0.5px; }
    .success-sub   { font-size: 15px; color: var(--dim); line-height: 1.65; margin-bottom: 32px; }

    @keyframes bounce {
      0%,80%,100% { transform: translateY(0); opacity: .4; }
      40%          { transform: translateY(-7px); opacity: 1; }
    }
    @keyframes pulse {
      0%,100% { opacity: 1; }
      50%      { opacity: .3; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.35s ease both; }

    @media (max-width: 520px) {
      .hero-title { font-size: 30px; }
      .feat-grid  { grid-template-columns: 1fr; }
      .question-title { font-size: 20px; }
      .options-grid.cols-2 { grid-template-columns: 1fr; }
      .versus-grid { grid-template-columns: 1fr 24px 1fr; gap: 6px; }
      .versus-card { padding: 14px 10px; }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="logo">AI<span>PLUS</span></div>
  <div class="badge">–ü—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –ï–ù–¢</div>
</header>

<main class="main" id="app"></main>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –í–ê–ñ–ù–û: –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ URL –≤–∞—à–µ–≥–æ Google Apps Script –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
const SHEETS_URL = "https://script.google.com/macros/s/AKfycbwqKVsSRaTZUt8JupKhH6gHhTUClT_S8CPEaTSUgtljUegaqxJqG3d629CW8n0ulk5z9w/exec";
const CLAUDE_API = "https://api.anthropic.com/v1/messages";

// ‚îÄ‚îÄ‚îÄ QUIZ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STEPS = [
  {
    id: "grade", type: "single", emoji: "üéì",
    question: "–í –∫–∞–∫–æ–º –∫–ª–∞—Å—Å–µ —É—á–∏—Ç—Å—è —Ä–µ–±—ë–Ω–æ–∫?",
    options: ["9 –∫–ª–∞—Å—Å","10 –∫–ª–∞—Å—Å","11 –∫–ª–∞—Å—Å"],
  },
  {
    id: "interests", type: "multi", emoji: "üí°",
    question: "–ß—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –Ω—Ä–∞–≤–∏—Ç—Å—è –∏ –¥–∞—ë—Ç—Å—è –ª–µ–≥–∫–æ?",
    hint: "–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ",
    options: ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ —Ç–æ—á–Ω—ã–µ –Ω–∞—É–∫–∏","–•–∏–º–∏—è –∏ –±–∏–æ–ª–æ–≥–∏—è","–ò—Å—Ç–æ—Ä–∏—è –∏ –æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ","–§–∏–∑–∏–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏","–Ø–∑—ã–∫–∏ –∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞","–ò—Å–∫—É—Å—Å—Ç–≤–æ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ","–°–ø–æ—Ä—Ç –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å","–ö–æ–º–ø—å—é—Ç–µ—Ä—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ"],
  },
  {
    id: "dream", type: "single", emoji: "üåü",
    question: "–ß—Ç–æ –±–ª–∏–∂–µ –∫ –º–µ—á—Ç–µ?",
    options: ["–ë—ã—Ç—å –≤—Ä–∞—á–æ–º –∏–ª–∏ –ø–æ–º–æ–≥–∞—Ç—å –ª—é–¥—è–º","–°–æ–∑–¥–∞–≤–∞—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã","–†–∞–±–æ—Ç–∞—Ç—å –≤ –±–∏–∑–Ω–µ—Å–µ –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏","–°—Ç–∞—Ç—å —É—á—ë–Ω—ã–º –∏–ª–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–º","–†–∞–±–æ—Ç–∞—Ç—å –≤ —é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏–∏ –∏–ª–∏ –≥–æ—Å—Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö","–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–π —Å—Ñ–µ—Ä–µ","–ó–∞–Ω–∏–º–∞—Ç—å—Å—è –ø–µ–¥–∞–≥–æ–≥–∏–∫–æ–π –∏–ª–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–µ–π","–†–∞–±–æ—Ç–∞—Ç—å –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö"],
  },
  {
    id: "priority", type: "single", emoji: "‚öñÔ∏è",
    question: "–ß—Ç–æ –≤–∞–∂–Ω–µ–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏?",
    options: ["–í—ã—Å–æ–∫–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞","–ü—Ä–µ—Å—Ç–∏–∂ –∏ —Å—Ç–∞—Ç—É—Å","–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–º–æ–≥–∞—Ç—å –ª—é–¥—è–º","–¢–≤–æ—Ä—á–µ—Å–∫–∞—è —Å–≤–æ–±–æ–¥–∞","–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å","–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"],
  },
  {
    id: "mbti_ei", type: "versus", emoji: "‚ö°",
    question: "–ì–¥–µ —Ç–µ–±–µ –ª—É—á—à–µ –≤—Å–µ–≥–æ?", axis: "E / I",
    left:  { emoji:"üó£Ô∏è", label:"–í —Ü–µ–Ω—Ç—Ä–µ –≤–Ω–∏–º–∞–Ω–∏—è",      desc:"–õ—é–±–ª—é –æ–±—â–∞—Ç—å—Å—è, –∑–∞—Ä—è–∂–∞—é—Å—å –æ—Ç –ª—é–¥–µ–π, –ª–µ–≥–∫–æ –∑–Ω–∞–∫–æ–º–ª—é—Å—å",                      tag:"–≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç (E)" },
    right: { emoji:"üéß", label:"–í —Å–≤–æ—ë–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ",   desc:"–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é –≥–ª—É–±–æ–∫–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã —Ç–µ—Ç-–∞-—Ç–µ—Ç, —É—Å—Ç–∞—é –æ—Ç —Ç–æ–ª–ø—ã",                   tag:"–ò–Ω—Ç—Ä–æ–≤–µ—Ä—Ç (I)" },
  },
  {
    id: "mbti_sn", type: "versus", emoji: "üî≠",
    question: "–ö–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å –∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—à—å –º–∏—Ä?", axis: "S / N",
    left:  { emoji:"üî©", label:"–§–∞–∫—Ç—ã –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞",        desc:"–î–æ–≤–µ—Ä—è—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º, –ª—é–±–ª—é —á—ë—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã",     tag:"–°–µ–Ω—Å–æ—Ä–Ω—ã–π (S)" },
    right: { emoji:"üí´", label:"–ò–¥–µ–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",      desc:"–î—É–º–∞—é –æ –±—É–¥—É—â–µ–º, –∏—â—É –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—Å—å –∫–æ–Ω—Ü–µ–ø—Ü–∏—è–º–∏",             tag:"–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π (N)" },
  },
  {
    id: "mbti_tf", type: "versus", emoji: "üß©",
    question: "–ö–∞–∫ —Ç—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ä–µ—à–µ–Ω–∏—è?", axis: "T / F",
    left:  { emoji:"üìê", label:"–õ–æ–≥–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑",         desc:"–û—Ü–µ–Ω–∏–≤–∞—é –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ ‚Äî –≤–∞–∂–Ω—ã —Ñ–∞–∫—Ç—ã –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å",                    tag:"–ú—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã–π (T)" },
    right: { emoji:"‚ù§Ô∏è", label:"–¶–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ª—é–¥–∏",         desc:"–î—É–º–∞—é –æ —Ç–æ–º, –∫–∞–∫ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –ª—é–¥–µ–π –≤–æ–∫—Ä—É–≥",                         tag:"–ß—É–≤—Å—Ç–≤—É—é—â–∏–π (F)" },
  },
  {
    id: "mbti_jp", type: "versus", emoji: "üóìÔ∏è",
    question: "–ö–∞–∫ —Ç—ã –æ—Ä–≥–∞–Ω–∏–∑—É–µ—à—å —Å–≤–æ—é –∂–∏–∑–Ω—å?", axis: "J / P",
    left:  { emoji:"‚úÖ", label:"–ü–ª–∞–Ω—ã –∏ –ø–æ—Ä—è–¥–æ–∫",          desc:"–õ—é–±–ª—é —Å–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á, —á—ë—Ç–∫–∏–π —Ä–∞—Å–ø–æ—Ä—è–¥–æ–∫ –∏ –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è",          tag:"–†–µ—à–∞—é—â–∏–π (J)" },
    right: { emoji:"üåä", label:"–ì–∏–±–∫–æ—Å—Ç—å –∏ —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ—Å—Ç—å", desc:"–ê–¥–∞–ø—Ç–∏—Ä—É—é—Å—å –Ω–∞ —Ö–æ–¥—É, –æ—Å—Ç–∞–≤–ª—è—é –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã–º–∏",                         tag:"–í–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π (P)" },
  },
];

const MBTI_STEPS = STEPS.filter(s => s.type === "versus");

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  screen: "welcome",   // welcome | quiz | contact | loading | result | success
  step: 0,
  answers: {},
  contact: { name: "", phone: "", city: "" },
  mbtiType: null,
  result: null,
  chat: [],
  chatLoading: false,
};

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getMBTI(ans) {
  return [
    ans.mbti_ei?.[0] === "left" ? "E" : "I",
    ans.mbti_sn?.[0] === "left" ? "S" : "N",
    ans.mbti_tf?.[0] === "left" ? "T" : "F",
    ans.mbti_jp?.[0] === "left" ? "J" : "P",
  ].join("");
}

function formatAnswers(ans) {
  return STEPS.map(s => {
    if (s.type === "versus") {
      const side = ans[s.id]?.[0];
      const chosen = side === "left" ? s.left : s.right;
      return `${s.question}: ${chosen ? chosen.tag : "‚Äî"}`;
    }
    return `${s.question}: ${(ans[s.id] || []).join(", ")}`;
  }).join("\n");
}

function el(id)   { return document.getElementById(id); }
function qs(sel)  { return document.querySelector(sel); }
function app()    { return document.getElementById("app"); }

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const { screen } = state;
  if      (screen === "welcome") renderWelcome();
  else if (screen === "quiz")    renderQuiz();
  else if (screen === "contact") renderContact();
  else if (screen === "loading") renderLoading();
  else if (screen === "result")  renderResult();
  else if (screen === "success") renderSuccess();
}

// ‚îÄ‚îÄ Welcome ‚îÄ‚îÄ
function renderWelcome() {
  app().innerHTML = `
  <div class="fade-in">
    <div class="hero-title">–ù–∞–π–¥–∏ —Å–≤–æ—ë<br><span style="color:var(--accent)">–ø—Ä–∏–∑–≤–∞–Ω–∏–µ</span> ‚Äî<br>–≤—ã–±–µ—Ä–∏ –ï–ù–¢ –ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>
    <div class="hero-sub">8 –≤–æ–ø—Ä–æ—Å–æ–≤ + MBTI-–ø—Ä–æ—Ñ–∏–ª—å ‚Üí –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –º–µ—á—Ç—ã ‚Üí –Ω—É–∂–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –ï–ù–¢ ‚Üí —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—É–∑–æ–≤.</div>
    <div class="feat-grid">
      ${[
        ["üß†","MBTI-–ø—Ä–æ—Ñ–∏–ª—å","4 –æ—Å–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ ‚Äî –ø–æ–Ω–∏–º–∞–µ–º, –∫—Ç–æ —Ç—ã –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ"],
        ["üéØ","–ü–æ–¥–±–æ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏","–¢–æ–ø-3 –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –ø–æ–¥ —Ç–≤–æ–π —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã"],
        ["üìö","–ü—Ä–µ–¥–º–µ—Ç—ã –ï–ù–¢","–¢–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å"],
        ["ü§ñ","–ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç","–ó–∞–¥–∞–π –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏"],
      ].map(([e,t,d]) => `
        <div class="feat-card">
          <div class="feat-emoji">${e}</div>
          <div class="feat-title">${t}</div>
          <div class="feat-desc">${d}</div>
        </div>
      `).join("")}
    </div>
    <button class="btn-primary" onclick="startQuiz()">–ù–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Üí</button>
    <div class="hero-note">–ó–∞–π–º—ë—Ç ~3 –º–∏–Ω—É—Ç—ã ‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Ä¢ –ë–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
  </div>`;
}

// ‚îÄ‚îÄ Quiz ‚îÄ‚îÄ
function renderQuiz() {
  const s = STEPS[state.step];
  const current = state.answers[s.id] || [];
  const pct = (state.step / STEPS.length) * 100;
  const isMBTI = s.type === "versus";
  const mbtiIdx = MBTI_STEPS.findIndex(x => x.id === s.id);
  const canNext = current.length > 0;

  let optionsHTML = "";

  if (isMBTI) {
    const selLeft  = current[0] === "left";
    const selRight = current[0] === "right";
    optionsHTML = `
      <div class="axis-row"><span class="axis-pill">–û—Å—å ${s.axis}</span></div>
      <div class="versus-grid">
        <div class="versus-card ${selLeft ? "sel-left" : ""}" onclick="selectVersus('left')">
          <div class="versus-emoji">${s.left.emoji}</div>
          <div class="versus-label">${s.left.label}</div>
          <div class="versus-desc">${s.left.desc}</div>
          <span class="versus-tag">${s.left.tag}</span>
        </div>
        <div class="vs-orb">VS</div>
        <div class="versus-card versus-right ${selRight ? "sel-right" : ""}" onclick="selectVersus('right')">
          <div class="versus-emoji" style="text-align:right">${s.right.emoji}</div>
          <div class="versus-label" style="text-align:right">${s.right.label}</div>
          <div class="versus-desc" style="text-align:right">${s.right.desc}</div>
          <span class="versus-tag" style="display:block;text-align:right">${s.right.tag}</span>
        </div>
      </div>`;
  } else {
    const cols = s.options.length > 4 ? "cols-2" : "cols-1";
    optionsHTML = `<div class="options-grid ${cols}">
      ${s.options.map(opt => {
        const sel = current.includes(opt);
        return `<button class="option-btn ${sel ? "selected" : ""}" onclick="toggleOption('${opt.replace(/'/g,"\\'")}')">
          <div class="check-circle">${sel ? "‚úì" : ""}</div>${opt}
        </button>`;
      }).join("")}
    </div>`;
  }

  app().innerHTML = `
  <div class="fade-in">
    <div class="progress-wrap"><div class="progress-fill" style="width:${pct}%"></div></div>
    <div class="step-label">${isMBTI
      ? `–¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ MBTI ‚Ä¢ ${mbtiIdx+1} –∏–∑ ${MBTI_STEPS.length}`
      : `–í–æ–ø—Ä–æ—Å ${state.step+1} –∏–∑ ${STEPS.length}${s.type === "multi" ? " ‚Ä¢ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤" : ""}`
    }</div>
    <span class="question-emoji">${s.emoji}</span>
    <div class="question-title">${s.question}</div>
    ${optionsHTML}
    <div class="btn-row">
      ${state.step > 0 ? `<button class="btn-back" onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>` : ""}
      <button class="btn-primary" onclick="nextStep()" ${!canNext ? "disabled" : ""}>
        ${state.step < STEPS.length - 1 ? "–î–∞–ª–µ–µ ‚Üí" : "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí"}
      </button>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ Contact form ‚îÄ‚îÄ
function renderContact() {
  const pct = (STEPS.length / (STEPS.length + 1)) * 100;
  app().innerHTML = `
  <div class="fade-in">
    <div class="progress-wrap"><div class="progress-fill" style="width:${pct}%"></div></div>
    <div class="step-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥</div>
    <span class="question-emoji">üìã</span>
    <div class="question-title">–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç?</div>
    <div style="font-size:14px;color:var(--dim);line-height:1.65;margin-bottom:28px">
      –ú–µ–Ω–µ–¥–∂–µ—Ä Aiplus —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏, —Ä–∞—Å—Å–∫–∞–∂–µ—Ç –ø—Ä–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∫ –ï–ù–¢ –∏ –∑–∞–ø–∏—à–µ—Ç –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É.
    </div>

    <div class="form-section">
      <label class="form-label" for="inp-name">–í–∞—à–µ –∏–º—è</label>
      <input class="form-input" id="inp-name" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–∏—è –ë–µ–∫–æ–≤–∞" value="${state.contact.name}" oninput="updateContact('name', this.value)" />
    </div>
    <div class="form-section">
      <label class="form-label" for="inp-phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
      <input class="form-input" id="inp-phone" type="tel" placeholder="+7 700 000 00 00" value="${state.contact.phone}" oninput="updateContact('phone', this.value)" />
    </div>
    <div class="form-section">
      <label class="form-label" for="inp-city">–ì–æ—Ä–æ–¥</label>
      <input class="form-input" id="inp-city" type="text" placeholder="–®—ã–º–∫–µ–Ω—Ç, –ê–ª–º–∞—Ç—ã, –ê—Å—Ç–∞–Ω–∞..." value="${state.contact.city}" oninput="updateContact('city', this.value)" />
    </div>

    <div class="btn-row">
      <button class="btn-back" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
      <button class="btn-primary" id="submit-btn" onclick="submitForm()">–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí</button>
    </div>
    <div class="form-note">
      –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.<br>
      –ú—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.
    </div>
  </div>`;
}

// ‚îÄ‚îÄ Loading ‚îÄ‚îÄ
function renderLoading() {
  app().innerHTML = `
  <div class="loading-screen fade-in">
    <div class="loading-emoji">‚ö°</div>
    <div class="loading-title">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã...</div>
    <div class="loading-sub">–ò–ò —Å—Ç—Ä–æ–∏—Ç –ø—Ä–æ—Ñ–∏–ª—å –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</div>
    <div class="dots-wrap">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ Result ‚îÄ‚îÄ
function renderResult() {
  const { result, mbtiType, chat, chatLoading } = state;

  const bubblesHTML = chat.map(m => `
    <div class="bubble ${m.role === "user" ? "user" : "bot"}">${escHtml(m.content)}</div>
  `).join("") + (chatLoading ? `<div class="chat-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>` : "");

  app().innerHTML = `
  <div class="fade-in">
    <div class="progress-wrap"><div class="progress-fill" style="width:100%"></div></div>
    <div class="result-header">‚ú¶ –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤</div>
    <div class="result-title">–¢–≤–æ–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</div>
    ${mbtiType ? `<div class="mbti-badge">üß† –¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏: <strong>${mbtiType}</strong></div>` : ""}
    <div class="result-box">${escHtml(result || "")}</div>

    <div class="chat-section-title"><span style="color:var(--accent)">ü§ñ</span> –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É</div>
    <div class="chat-subtitle">–°–ø—Ä–æ—Å–∏ –ø—Ä–æ –≤—É–∑, –ø—Ä–æ—Ñ–µ—Å—Å–∏—é, –ø—Ä–µ–¥–º–µ—Ç –ï–ù–¢ –∏–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É</div>
    <div class="chat-wrap">
      <div class="chat-head"><div class="chat-dot"></div>–ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç Aiplus</div>
      <div class="chat-msgs" id="chat-msgs">${bubblesHTML}</div>
      <div class="chat-input-row">
        <input class="chat-input" id="chat-input" placeholder="–ó–∞–¥–∞–π –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å..." onkeydown="if(event.key==='Enter')sendChat()" />
        <button class="send-btn" id="send-btn" onclick="sendChat()" ${chatLoading?"disabled":""}>‚Üí</button>
      </div>
    </div>

    <div class="aiplus-cta">
      <strong class="accent">üéì –ì–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –ï–ù–¢ —Å–∏—Å—Ç–µ–º–Ω–æ?</strong><br>
      <span class="dimmed">–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä <strong>Aiplus</strong> ‚Äî 10 –ª–µ—Ç –æ–ø—ã—Ç–∞, 5000+ –ø–æ—Å—Ç—É–ø–∏–≤—à–∏—Ö, –∫–∞–∂–¥—ã–π 4-–π –≤ –ù–ò–®.
      –ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ <strong class="accent">–±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</strong>.</span>
    </div>
  </div>`;

  scrollChatDown();
}

// ‚îÄ‚îÄ Success ‚îÄ‚îÄ
function renderSuccess() {
  app().innerHTML = `
  <div class="success-screen fade-in">
    <div class="success-icon">‚úÖ</div>
    <div class="success-title">–ì–æ—Ç–æ–≤–æ! –ñ–¥–∏—Ç–µ –∑–≤–æ–Ω–∫–∞</div>
    <div class="success-sub">
      –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.<br>
      –ú–µ–Ω–µ–¥–∂–µ—Ä <strong>Aiplus</strong> —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è.<br><br>
      –ú—ã –∑–∞–ø–∏—à–µ–º –≤–∞—Å –Ω–∞ <strong>–±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</strong> —É—Ä–æ–≤–Ω—è –∑–Ω–∞–Ω–∏–π.
    </div>
    <button class="btn-primary" onclick="location.reload()">–ü—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑</button>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startQuiz() {
  state.screen = "quiz";
  state.step = 0;
  render();
}

function toggleOption(opt) {
  const s = STEPS[state.step];
  const cur = state.answers[s.id] || [];
  if (s.type === "multi") {
    state.answers[s.id] = cur.includes(opt) ? cur.filter(x => x !== opt) : [...cur, opt];
  } else {
    state.answers[s.id] = [opt];
  }
  render();
}

function selectVersus(side) {
  const s = STEPS[state.step];
  state.answers[s.id] = [side];
  render();
}

function nextStep() {
  if (state.step < STEPS.length - 1) {
    state.step++;
    render();
    window.scrollTo({ top: 0, behavior: "smooth" });
  } else {
    state.screen = "contact";
    render();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
}

function prevStep() {
  if (state.step > 0) {
    state.step--;
    render();
  }
}

function goBack() {
  state.screen = "quiz";
  state.step = STEPS.length - 1;
  render();
}

function updateContact(field, value) {
  state.contact[field] = value;
}

async function submitForm() {
  const { name, phone, city } = state.contact;
  if (!name.trim() || !phone.trim() || !city.trim()) {
    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
    return;
  }

  const btn = el("submit-btn");
  if (btn) { btn.disabled = true; btn.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º..."; }

  state.screen = "loading";
  render();

  // Generate MBTI
  state.mbtiType = getMBTI(state.answers);

  // Generate AI result
  const answersText = formatAnswers(state.answers);
  try {
    const text = await callClaude(
      [{ role: "user", content: `MBTI: ${state.mbtiType}\n\n–ê–Ω–∫–µ—Ç–∞:\n${answersText}` }],
      RESULT_PROMPT
    );
    state.result = text;
    state.chat = [{
      role: "assistant",
      content: `–ü—Ä–∏–≤–µ—Ç! –¢–≤–æ–π —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ ‚Äî ${state.mbtiType} üß†\n–Ø –∏–∑—É—á–∏–ª —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å. –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø—Ä–æ –≤—É–∑—ã, –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, –ø—Ä–µ–¥–º–µ—Ç—ã –ï–ù–¢ –∏–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É!`
    }];
  } catch (e) {
    state.result = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
  }

  // Send to Google Sheets
  try {
    await sendToSheets({
      timestamp: new Date().toLocaleString("ru-KZ"),
      name, phone, city,
      grade:    (state.answers.grade || []).join(", "),
      interests:(state.answers.interests || []).join(", "),
      dream:    (state.answers.dream || []).join(", "),
      priority: (state.answers.priority || []).join(", "),
      mbti_ei:  getVersusTag("mbti_ei"),
      mbti_sn:  getVersusTag("mbti_sn"),
      mbti_tf:  getVersusTag("mbti_tf"),
      mbti_jp:  getVersusTag("mbti_jp"),
      mbti_type: state.mbtiType,
      ai_result: state.result,
    });
  } catch(e) {
    console.warn("Sheets error:", e);
  }

  state.screen = "result";
  render();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function getVersusTag(id) {
  const s = STEPS.find(x => x.id === id);
  const side = state.answers[id]?.[0];
  if (!s || !side) return "‚Äî";
  return side === "left" ? s.left.tag : s.right.tag;
}

async function sendChat() {
  const input = el("chat-input");
  const text = input.value.trim();
  if (!text || state.chatLoading) return;
  input.value = "";
  state.chat.push({ role: "user", content: text });
  state.chatLoading = true;
  renderResult();
  scrollChatDown();

  try {
    const reply = await callClaude(
      state.chat.map(m => ({ role: m.role, content: m.content })),
      chatSysPrompt()
    );
    state.chat.push({ role: "assistant", content: reply });
  } catch {
    state.chat.push({ role: "assistant", content: "–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑." });
  }
  state.chatLoading = false;
  renderResult();
  scrollChatDown();
}

function scrollChatDown() {
  setTimeout(() => {
    const msgs = el("chat-msgs");
    if (msgs) msgs.scrollTop = msgs.scrollHeight;
  }, 50);
}

function escHtml(str) {
  return (str || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
}

// ‚îÄ‚îÄ‚îÄ API CALLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function callClaude(messages, system) {
  const res = await fetch(CLAUDE_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 1000, system, messages }),
  });
  const d = await res.json();
  if (d.error) throw new Error(d.error.message);
  return d.content?.[0]?.text || "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞.";
}

async function sendToSheets(data) {
  if (!SHEETS_URL || SHEETS_URL === "https://script.google.com/macros/s/AKfycbwqKVsSRaTZUt8JupKhH6gHhTUClT_S8CPEaTSUgtljUegaqxJqG3d629CW8n0ulk5z9w/exec") return;
  await fetch(SHEETS_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data),
  });
}

// ‚îÄ‚îÄ‚îÄ PROMPTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RESULT_PROMPT = `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Å–∏—Å—Ç–µ–º–µ –ï–ù–¢ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ. –†–∞–±–æ—Ç–∞–µ—à—å –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–º —Ü–µ–Ω—Ç—Ä–µ Aiplus.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∞–Ω–∫–µ—Ç—É —É—á–µ–Ω–∏–∫–∞ (–≤–∫–ª—é—á–∞—è MBTI-—Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏) –∏ —Å–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç:

üß† –¢–í–û–ô –¢–ò–ü –õ–ò–ß–ù–û–°–¢–ò
2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, —Å—Ç–∏–ª—å –º—ã—à–ª–µ–Ω–∏—è, –∫–∞–∫ —Ç–∏–ø –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏.

üéØ –¢–û–ü-3 –ü–†–û–§–ï–°–°–ò–ò –î–õ–Ø –¢–ï–ë–Ø
–î–ª—è –∫–∞–∂–¥–æ–π: –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Üí 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–µ–±–µ ‚Üí –ø—Ä–∏–º–µ—Ä–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ.

üìö –ü–†–ï–î–ú–ï–¢–´ –ï–ù–¢
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (–≤—Å–µ): –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è, –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å, –∏—Å—Ç–æ—Ä–∏—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.
–ü—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã: –¥–ª—è –∫–∞–∂–¥–æ–π –∏–∑ 3 –ø—Ä–æ—Ñ–µ—Å—Å–∏–π ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫.

üèõÔ∏è –õ–£–ß–®–ò–ï –í–£–ó–´ –ö–ê–ó–ê–•–°–¢–ê–ù–ê
–¢–æ–ø-3: –≤—É–∑ + —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å + –ø—Ä–∏–º–µ—Ä–Ω—ã–π –ø—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª.

üí™ –¢–í–û–ò –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´
2-3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∫–µ—Ç—ã.

‚ö° –ß–¢–û –î–ï–õ–ê–¢–¨ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°
3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏.

–ü–∏—à–∏ –∂–∏–≤–æ –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–µ, –Ω–∞ ¬´—Ç—ã¬ª. –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.`;

function chatSysPrompt() {
  return `–¢—ã ‚Äî –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ Aiplus (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω).

–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞:
${state.result}

MBTI: ${state.mbtiType}
–ê–Ω–∫–µ—Ç–∞:
${formatAnswers(state.answers)}

–û–± Aiplus: 10 –ª–µ—Ç, 9 —Ñ–∏–ª–∏–∞–ª–æ–≤, 5000+ –ø–æ—Å—Ç—É–ø–∏–≤—à–∏—Ö, –∫–∞–∂–¥—ã–π 4-–π –≤ –ù–ò–®. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ù–¢, –ù–ò–®, –ö–¢–õ, –†–§–ú–®. 65 000‚Äì85 000 —Ç–≥/–º–µ—Å. –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.

–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ (2‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π). –ï—Å–ª–∏ –ø—Ä–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É. –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.`;
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
render();
</script>
</body>
</html>
